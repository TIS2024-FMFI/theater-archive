{% extends 'archive_app/index.html' %}
{% load static %}
{% block content %}
<section class="content">
    <link rel="stylesheet" href="{%  static 'archive_app/form_concerts_and_events.css' %}">
    <div class="form-container">

        <h2>{% if repeat.id %}Upraviť{% else %}Pridať{% endif %} konkrétne predstavenie</h2>
        <form id="repeat-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}


            <!-- Event Type, Date, and Location -->
            <div class="form-group">
                <label for="event-type">Typ podujatia:</label>
                <select id="event-type" name="repeat_type">
                    {% for r in repeat_form.repeat_type.field.queryset %}
                        <option value="{{ r.id }}" {% if repeat.repeat_type == r %}selected{% endif %}>{{ r.name }}</option>
                    {% endfor %}
{#                    <option value="repriza">Repríza</option>#}
                </select>
            </div>

            <div class="form-group">
                <label for="event-date">Dátum a čas:</label>
                <input type="datetime-local" name="date" id="event-date" {% if repeat.id %} value="{{ repeat_form.date.value|date:'Y-m-d\TH:i' }}" {% endif %}>
            </div>

            <div class="form-group">
                <label for="venue">Miesto:</label>
                <select id="venue" name="room">
                    <option value="">Iná miestmosť</option>
                    {% for r in repeat_form.room.field.queryset %}
                        <option value="{{ r.id }}" {% if repeat.room == r %}selected{% endif %}>{{ r.name }}</option>
                    {% endfor %}
                </select>
                <input type="text" id="other-venue" placeholder="Zadajte inú miestnosť" name="new_room" style="display: block">
            </div>

            <div class="form-group">
                <label for="file">Súbor:</label>
                <select id="file" name="ensemble">
                   {% for e in repeat_form.ensemble.field.queryset %}
                        <option value="{{ e.id }}" {% if repeat.ensemble == e %}selected{% endif %}>{{ e.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Cast Section -->
            <h3>Obsadenie</h3>
            <div class="role_container">

                {{ performer_formset.management_form }}
                {% for form in performer_formset %}
                <div id="role_entry" class="role_entry">

                    {{ form.id.as_hidden }}
                    <div class="form-group">
                        <label for="role">Postava:</label>
                        <input type="text" id="role" placeholder="Postava" name="{{ form.job_name.html_name }}" value="{{ form.instance.employee_job.job|default:'' }}" class="form-control">
                        <button type="button" class="btn remove-role">&#10006;</button>
                        <input type="checkbox" name="{{ form.DELETE.html_name }}" class="delete-checkbox" style="display: none;">
                    </div>

                    <div class="form-group actor">
                        <label for="actor">Herec / Herečka:</label>
                        <input type="text" id="actor" class="actor" placeholder="Umelec" list="autocomplete" name="{{ form.employee.html_name }}" value="{{ form.instance.employee_job.employee|default:'' }}">

                        <datalist id="autocomplete">
                          {% for e in employees %}
                              <option value="{{ e.first_name }} {{ e.last_name }}"></option>
                          {% endfor %}
                        </datalist>

                        <input type="checkbox" name="{{ form.DELETE.html_name }}" class="delete-checkbox" style="display: none;">
                        <button type="button" class="btn" style="visibility: hidden;">&#10006;</button>
                    </div>

                    <div class="form-group">
                        <label></label>
                        <button type="button" class="add-btn add-actor" id="add_actor">&#10010;</button>
                    </div>

                </div>

                {% endfor %}
            </div>
            <button type="button" class="add-btn role" id="add_role">&#10010; pridať postavu</button>

            <!-- File Upload Section -->
            <!-- Prílohy -->
            <h3> Prílohy:</h3>

            <div class="form-group upload-section">
                <label class="upload-label">Články a kritiky&ensp;
                    <input type="file" id="upload-articles" name="documents_articles" multiple accept=".pdf,.doc,.docx" onchange="updateFileList('articles')">
                </label>
                <ul id="file-list-articles">
                    {% for doc in existing_files.documents_articles %}
                        <li id="file-item-{{ doc.id }}">
                            <a href="{{ doc.document.document_path.url }}" target="_blank">{{ doc.document.document_path.name }}</a>
                            {% if not is_copy %}
                                <button type="button" onclick="removeFile('{{ doc.id }}')">❌</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="form-group upload-section">
                <label class="upload-label">Plagát a bulletin&ensp;
                    <input type="file" id="upload-posters" name="documents_posters" multiple accept=".pdf,.doc,.docx" onchange="updateFileList('posters')">
                </label>
                <ul id="file-list-posters">
                    {% for doc in existing_files.documents_posters %}
                        <li id="file-item-{{ doc.id }}">
                            <a href="{{ doc.document.document_path.url }}" target="_blank">{{ doc.document.document_path.name }}</a>
                            {% if not is_copy %}
                                <button type="button" onclick="removeFile('{{ doc.id }}')">❌</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="form-group upload-section">
                <label class="upload-label">Fotografie&ensp;
                    <input type="file" id="upload-photos" name="documents_photos" multiple accept="image/*" onchange="updateFileList('photos')">
                </label>
                <ul id="file-list-photos">
                    {% for doc in existing_files.documents_photos %}
                        <li id="file-item-{{ doc.id }}">
                            <a href="{{ doc.document.document_path.url }}" target="_blank">{{ doc.document.document_path.name }}</a>
                            {% if not is_copy %}
                                <button type="button" onclick="removeFile('{{ doc.id }}')">❌</button>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Publish and Submit -->
            <div class="form-actions">
                <label for="publish" class="publish">
                    <input type="checkbox" id="publish" name="publicity" {% if employee_form.publicity.value == True %} checked {% endif %}> Zverejniť
                </label>
                <button type="button" class="submit" onclick="submitRepeatForm()">Uložiť</button>
            </div>

        </form>
    </div>
</section>

<script>
    let selectedFiles = {
        articles: [],
        posters: [],
        photos: []
    };

    function updateFileList(fileType) {
        let fileInput = document.getElementById(`upload-${fileType}`);
        let fileList = document.getElementById(`file-list-${fileType}`);
        let files = Array.from(fileInput.files);

        selectedFiles[fileType] = selectedFiles[fileType].concat(files);

        fileList.innerHTML = "";
        selectedFiles[fileType].forEach((file, index) => {
            let listItem = document.createElement("li");
            listItem.textContent = file.name;
            let removeBtn = document.createElement("button");
            removeBtn.textContent = "❌";
            removeBtn.addEventListener("click", function () {
                selectedFiles[fileType].splice(index, 1);
                updateFileList(fileType);
            });
            listItem.appendChild(removeBtn);
            fileList.appendChild(listItem);
        });

        fileInput.value = "";
    }

    function submitRepeatForm() {
        let form = document.getElementById("repeat-form");
        let formData = new FormData(form);

        Object.keys(selectedFiles).forEach(fileType => {
            selectedFiles[fileType].forEach(file => {
                formData.append(`documents_${fileType}`, file);
            });
        });

        console.log("Submitting FormData:", formData);  // ✅ Debug log

        fetch(form.action, {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert("Chyba pri ukladaní: " + JSON.stringify(data.errors));
            }
        })
        .catch(error => console.error("Chyba:", error));
    }

    // Funkcia na odstránenie už existujúceho súboru
    document.querySelectorAll(".remove-file").forEach(button => {
        button.addEventListener("click", function () {
            let fileId = this.dataset.fileId;
            let fileType = this.dataset.fileType;
            let listItem = this.parentElement;

            fetch(`/remove_file/${fileId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken")
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    listItem.remove();
                } else {
                    alert("Nepodarilo sa odstrániť súbor.");
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        let form = document.getElementById("repeat-form");

        form.addEventListener("submit", function (event) {
            event.preventDefault();  // ✅ Zabráni štandardnému submit-u
            let formData = new FormData(form);

            console.log("Odosielam FormData:", formData); // ✅ Debug v konzole

            fetch(form.action, {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = data.redirect_url;  // ✅ Správne presmerovanie
                } else {
                    alert("Chyba pri ukladaní: " + JSON.stringify(data.errors));
                }
            })
            .catch(error => console.error("Chyba:", error));
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}