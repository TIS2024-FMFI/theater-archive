{% extends 'archive_app/index.html' %}
{% load static %}
{% block content %}
<section class="content">
    <link rel="stylesheet" href="{%  static 'archive_app/form_concerts_and_events.css' %}">
    <div class="form-container">
        <h2>Nový koncert/podujatie</h2>

        <form>
            <div class="form-group">
                <label for="date">Dátum :</label>
                <input type="date" id="date" name="date">
            </div>

            <div class="form-group">
                <label for="event-type">Koncert/podujatie :</label>
                <select id="event-type" name="event-type">
                    <option value="koncert">Koncert</option>
                    <option value="podujatie">Podujatie</option>
                </select>
            </div>

            <div class="form-group">
                <label for="title">Názov :</label>
                <input type="text" id="title" name="title" placeholder="Názov koncertu / podujatia">
            </div>

            <div class="form-group">
                <label for="description">Popis :</label>
                <textarea id="description" name="description" rows="5" placeholder="Sem píšte popis..."></textarea>
            </div>

            <h3>Inscenačný tím :</h3>
            <div class="form-group">
                <label for="director">Réžia :</label>
                <select id="director" name="director">
                    <option value="">-</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="scene">Scéna :</label>
                <select id="scene" name="scene">
                    <option value="">-</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="dramaturgy">Dramaturg :</label>
                <select id="dramaturgy" name="dramaturgy">
                    <option value="">-</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <h3>Účinkujúci :</h3>
            <div class="form-group">
                <label for="position">Zaradenie :</label>
                <select id="position" name="position">
                    <option value="">-</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}">{{ employee.first_name }} {{ employee.last_name }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="btn">&#10006;</button>
            </div>

            <div class="form-group">
                <label></label>
                <button type="button" class="btn">&#10010;</button>
            </div>

            <h3> Prílohy:</h3>
            <div class="form-group upload-section">
                <label class="upload-label">Program&ensp;
                    <input type="file" id="upload-program" name="documents_program" multiple accept=".pdf,.doc,.docx" onchange="updateFileList('program')">
                </label>
                <ul id="file-list-program"></ul>
            </div>

            <div class="form-group upload-section">
                <label class="upload-label">Fotografie&ensp;
                    <input type="file" id="upload-photos" name="documents_photos" multiple accept="image/*" onchange="updateFileList('photos')">
                </label>
                <ul id="file-list-photos"></ul>
            </div>

            <div class="form-actions">
                <label for="publish" class="publish">
                    <input type="checkbox" name="publicity"> Zverejniť
                </label>
                <button type="button" class="submit" onclick="submitConcertForm()">Uložiť</button>
            </div>
        </form>
    </div>
</section>

<script>
    let selectedFiles = {
        program: [],
        photos: []
    };

    function updateFileList(fileType) {
        let fileInput = document.getElementById(`upload-${fileType}`);
        let fileList = document.getElementById(`file-list-${fileType}`);
        let files = Array.from(fileInput.files);

        selectedFiles[fileType] = selectedFiles[fileType].concat(files);

        fileList.innerHTML = "";
        selectedFiles[fileType].forEach((file, index) => {
            let listItem = document.createElement("li");
            listItem.textContent = file.name;
            listItem.appendChild(createRemoveButton(fileType, index));
            fileList.appendChild(listItem);
        });

        fileInput.value = "";
    }

    function createRemoveButton(fileType, index) {
        let removeButton = document.createElement("button");
        removeButton.textContent = "❌";
        removeButton.style.marginLeft = "10px";
        removeButton.onclick = function() {
            selectedFiles[fileType].splice(index, 1);
            updateFileList(fileType);
        };
        return removeButton;
    }

    function submitConcertForm() {
        let form = document.getElementById("concert-form");
        let formData = new FormData(form);

        // Pridanie súborov do FormData
        Object.keys(selectedFiles).forEach(fileType => {
            selectedFiles[fileType].forEach(file => {
                formData.append(`documents_${fileType}`, file);
            });
        });

        fetch("{% url 'form_concerts_and_events' %}", {
            method: "POST",
            body: formData,
            headers: { "X-CSRFToken": getCookie("csrftoken") }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                alert("Chyba pri ukladaní: " + JSON.stringify(data.errors));
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            let cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
